# 第十六章 正则表达式类



## 16.1 关于正则表达式

用于匹配字符串

`Regexp` 类对象称为“正则表达式对象”，或直接称为“正则表达式”

创建正则表达式

* `//`
* `Regexp.new(str) `
* `%r()`、`%r< >`、`%r| |`、`%r! !`

```
%r|http://([^/]*)/|  #=> /http:\/\/([^\/]*)\//
```





## 16.2 正则表达式的模式与匹配

`=~`，判断正则表达式与指定字符串是否匹配，返回匹配位置的数字

`!~` ，颠倒“真”与“假”，返回 `true` 或 `false`

### 元字符

`^` 表示匹配行首

`$` 表示匹配行尾

`\A` 匹配字符串的开头

`\z` 匹配字符串的末尾

`\Z` 匹配字符串的末尾，如果字符串末尾是换行符，则匹配换行符前一个字符。——这个元字符很少用

```
p "abc\n".gsub(/\z/, "!")    => "abc\n!"
p "abc\n".gsub(/\Z/, "!")    => "abc!\n!"
```

`[a-zA-Z0-9-]` 选择多个字符中的 1 个。单纯的字符 `-`，那么就必须写在模式的开头或者末尾

`[^a-z]` 这里的 `^` 表示 a-z 以外的字符

``` 
/[^0-9][^A-Z]/ =~ "1A2B3C"  #=> 1
```

`.` 匹配任意字符。**希望指定字符数时使用；**16.2.6 节使用。

`\s` 空白符（空格 \p、制表 \t、换行 \n、换页）

`\d` 数字 0-9

`\w` 数字与英文字母

`\` 转义

`*` 重复 0 次以上

`+` 重复 1 次以上

`?` 重复 0 次或 1 次以上

`*?` 0 次以上的重复中最短的部分

`+?` 1 次以上的重复中最短的部分

`|` 在几个候补模式中匹配任意一个，比如 `/^(ABC|DEF)$/`



## 16.3 使用 quote 方法的正则表达式

`quote` 转义正则表达式所有元字符。

在写一些复杂的正则表达式时，建议不要使用 `quote` 方法



## 16.4 正则表达式的选项

`/../i` 忽略英文字母大小写

`/../x` 忽略正则表达式中的空白字符以及 `#` 后面的字符的选项（用于写注释）

`/../m` 匹配多行

```
str = "ABC\nDEF\nGHI"
p /DEF.GHI/ =~ str     #=> nil
p /DEF.GHI/m =~ str    #=> 4
```

`/../o` 只使用一次内嵌表达式



## 16.5 捕获

所谓捕获，就是从正则表达式的匹配部分中提取其中的某部分。通过 `$数字` 这种形式的变量，就可以获取匹配了正则表达式中的用 `()` 括住的部分的字符串。

```
/(.)(.)(.)/ =~ "abc"
p $0   #=> "irb"
p $1   #=> "a"
p $2   #=> "b"
p $3   #=> "c"
```

可以使用 `(?: )` 过滤不需要捕获的部分

```
/(.)(\d\d)+(.)/ =~ "123456"
p $1    #=> "1"
p $2    #=> "45"
p $3    #=> "6"
/(.)(?:\d\d)+(.)/ =~ "123456"
p $1    #=> "1"
p $2    #=> "6"
```

$`  匹配部分前的字符串

`$&` 匹配的字符串

`$'` 匹配部分后的字符串

```
/C./ =~ "ABCDEF"
p $`    #=> "AB"
p $&    #=> "CD"
p $'    #=> "EF"
```



## 16.6 使用正则表达式的方法

`sub` 方法与 `gsub` 方法都有两个参数。第 1 个参数用于指定希望匹配的正则表达式的模式，第 2 个参数用于指定与匹配部分置换的字符。`sub` 方法只置换首次匹配的部分，而 `gsub` 方法则会置换所有匹配的部分。

```
str = "abc   def  g   hi"
p str.sub(/\s+/,' ')     #=> "abc def  g   hi"
p str.gsub(/\s+/,' ')    #=> "abc def g hi"
```

使用块

```
str = "abracatabra"
nstr = str.sub(/.a/) do |matched|
  '<'+matched.upcase+'>'
end
p nstr    #=> "ab<RA>catabra"

nstr = str.gsub(/.a/) do |matched|
  '<'+matched.upcase+'>'
end
p nstr    #=> "ab<RA><CA><TA>b<RA>"
```

`scan` 方法能像 `gsub` 方法那样获取匹配部分的字符，但不能做置换操作。



## 16.7 正则表达式的例子

入门

```
str = "http://www.ruby-lang.org/ja/"
%r|http://([^/]*)/| =~ str
print "server address: ", $1, "\n"
```

例如，http://www.example.co.jp/foo/?name=bar#bar 这个 URI 的情况下，http 为通信协议名，www.example.co.jp 为服务器地址，/foo/ 为路径名，name=bar 为请求名，baz 为片段。

如果用这个正则表达式进行匹配，则 HTTP 等协议名会被保存在 `$2` 中，服务器地址等会被保存在 `$4` 中，路径名会被保存在 `$5`中，请求部分会被保存在 `$7` 中，片段（fragment）会被保存在 `$9` 中。

```
%r|^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?|
```

